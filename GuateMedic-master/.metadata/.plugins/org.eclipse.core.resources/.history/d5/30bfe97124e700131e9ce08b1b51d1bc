package com.example.guatemedic;

import java.io.IOException;
import java.util.concurrent.ExecutionException;

import org.json.JSONException;
import org.json.JSONObject;

import android.content.Intent;
import android.os.AsyncTask;
import android.os.Bundle;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.EditText;
import android.widget.Toast;

public class AuthorizationUploadPageFragment extends Fragment {
	
	private Button mAuthorizationButton;
	private String username;
	private String password;
	
	public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
		//Inflate the layout for this fragment
		View v = inflater.inflate(R.layout.authorization_page_fragment, container, false);
		
		mAuthorizationButton = (Button)v.findViewById(R.id.authorization_button);
		mAuthorizationButton.setOnClickListener(new View.OnClickListener() {
			@Override
			public void onClick(View v) {
				EditText username_input = (EditText)getActivity().findViewById(R.id.username_text);
				username = username_input.getText().toString();
				EditText password_input = (EditText)getActivity().findViewById(R.id.password_text);
				password = password_input.getText().toString();
				
				try {
					new HandleLoginTask().execute().get();
				} catch (InterruptedException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				} catch (ExecutionException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				} //Adding .get() forces it to return

			}
		});
		
		return v;
	}
	
	private class HandleLoginTask extends AsyncTask<Void, Void, Void> {
		private String authorizationKey;
		
		@Override
		protected Void doInBackground(Void... params) {	
			try {				
				String jsonBody = "{\"username\":\"" + username + "\", \"password\":\"" + password + "\"}";
				String response = new HttpPostRequest().postUrl("https://guatemedic.herokuapp.com/login", null, jsonBody);
				if (response == null) 
					return null;
				JSONObject obj = new JSONObject(response);
				if (obj.getString("status").equals("success")) {
					authorizationKey = obj.getString("auth_key");
				} 
			} catch (IOException | JSONException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			return null;
		}
		
		@Override
		protected void onPreExecute() {
			
		}
		
		@Override
		protected void onPostExecute(Void result) {
			if (authorizationKey != null) {
				BasicRecordsStore.get(getActivity().getApplication()).setAuthKey(authorizationKey);
				BasicRecordsStore.get(getActivity().getApplication()).setData();
				Intent intent = new Intent(getActivity(), SelectDataActivity.class);
				startActivity(intent);	
			} else {
				Toast.makeText(getActivity(), "Failure", Toast.LENGTH_LONG).show();

			}
		}

}
